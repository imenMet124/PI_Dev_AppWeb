{% extends 'Back_Base.html.twig' %}

{% block title %}Tasks Management{% endblock %}

{% block body %}
<div class="wrapper">
    <div class="main-panel">
        <div class="content">
            <div class="page-inner">
                <div class="page-header d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h4 class="page-title fw-bold">Tasks Management</h4>
                        <p class="text-muted">Manage all your organization's tasks</p>
                    </div>
                    <div>
                        <a href="{{ path('app_task_new') }}" class="btn btn-primary btn-rounded shadow-sm">
                            <i class="fas fa-plus me-2"></i>Add New Task
                        </a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3">
                                <form class="mb-0">
                                    <div class="input-group input-group-merge shadow-sm">
                                        <span class="input-group-text bg-transparent border-end-0">
                                            <i class="fas fa-search text-muted"></i>
                                        </span>
                                        <input type="text" id="search-input" name="search" class="form-control border-start-0" 
                                               placeholder="Search tasks by title, status, priority..." value="{{ search }}" autocomplete="off">
                                    </div>
                                </form>
                            </div>
                            <div class="card-body">
                                <div id="tasks-list">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle" id="tasksTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Status</th>
                                                    <th>Priority</th>
                                                    <th>Progress</th>
                                                    <th>Deadline</th>
                                                    <th>Assigned To</th>
                                                    <th class="text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for task in tasks %}
                                                    <tr>
                                                        <td class="fw-medium">{{ task.titreTache }}</td>
                                                        <td>
                                                            {% set statusClass = {
                                                                'Completed': 'success',
                                                                'In Progress': 'primary',
                                                                'Not Started': 'secondary'
                                                            } %}
                                                            {% set status = task.statutTache ?? 'Not Started' %}
                                                            <span class="badge bg-{{ statusClass[status] ?? 'secondary' }} rounded-pill px-3 py-2">
                                                                {{ status }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            {% set priorityClass = {
                                                                'High': 'danger',
                                                                'Medium': 'warning',
                                                                'Low': 'info'
                                                            } %}
                                                            {% set priority = task.priorite ?? 'No Priority' %}
                                                            <span class="badge bg-{{ priorityClass[priority] ?? 'light text-dark' }} rounded-pill px-3 py-2">
                                                                {{ priority }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                                    <div class="progress-bar bg-{{ task.statutTache == 'Completed' ? 'success' : 'primary' }}" 
                                                                        role="progressbar" 
                                                                        style="width: {{ task.progression ?? 0 }}%" 
                                                                        aria-valuenow="{{ task.progression ?? 0 }}" 
                                                                        aria-valuemin="0" 
                                                                        aria-valuemax="100">
                                                                    </div>
                                                                </div>
                                                                <span class="text-muted small fw-bold">{{ task.progression ?? 0 }}%</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            {% if task.deadline %}
                                                                <span class="badge bg-light text-dark border px-3 py-2">
                                                                    <i class="far fa-calendar-alt me-1"></i>
                                                                    {{ task.deadline|date('Y-m-d') }}
                                                                </span>
                                                            {% else %}
                                                                <span class="text-muted">Not set</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% for affectation in task.affectations %}
                                                                <span class="badge bg-secondary rounded-pill">
                                                                    <i class="fas fa-user me-1"></i>
                                                                    {{ affectation.employe.email }}
                                                                </span>
                                                            {% else %}
                                                                <span class="text-muted fst-italic">Unassigned</span>
                                                            {% endfor %}
                                                        </td>
                                                        <td>
                                                            <div class="d-flex justify-content-center gap-2">
                                                                <a href="{{ path('app_task_show', {'id_tache': task.idTache}) }}" 
                                                                   class="btn btn-sm btn-outline-primary rounded-pill" 
                                                                   data-bs-toggle="tooltip" title="View Details">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <a href="{{ path('app_task_edit', {'id_tache': task.idTache}) }}" 
                                                                   class="btn btn-sm btn-outline-info rounded-pill"
                                                                   data-bs-toggle="tooltip" title="Edit Task">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                                <form method="post" action="{{ path('app_task_delete', {'id_tache': task.idTache}) }}" 
                                                                      onsubmit="return confirm('Are you sure you want to delete this task?');" 
                                                                      style="display: inline-block;">
                                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ task.idTache) }}">
                                                                    <button class="btn btn-sm btn-outline-danger rounded-pill"
                                                                            data-bs-toggle="tooltip" title="Delete Task">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% else %}
                                                    <tr>
                                                        <td colspan="7" class="text-center py-5">
                                                            <div class="text-muted">
                                                                <i class="fas fa-tasks fa-3x mb-3"></i>
                                                                <p>No tasks found. Create your first task!</p>
                                                                <a href="{{ path('app_task_new') }}" class="btn btn-sm btn-outline-primary">
                                                                    <i class="fas fa-plus me-1"></i> Add New Task
                                                                </a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="navigation d-flex justify-content-center mt-4">
                                        {{ knp_pagination_render(tasks) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Dynamic search
    const searchInput = document.getElementById('search-input');
    let timeout = null;
    searchInput.addEventListener('input', function () {
        clearTimeout(timeout);
        timeout = setTimeout(function () {
            const query = searchInput.value;
            const url = new URL(window.location.href);
            url.searchParams.set('search', query);
            url.searchParams.set('page', 1);
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newList = doc.getElementById('tasks-list');
                    if (newList) {
                        document.getElementById('tasks-list').innerHTML = newList.innerHTML;
                        // Reinitialize tooltips after DOM update
                        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl)
                        });
                    }
                });
        }, 200);
    });
});
</script>
{% endblock %}