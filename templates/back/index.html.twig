    {% extends 'Back_Base.html.twig' %}

{% block body %}
<!-- Page Header -->
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h2 class="fw-bold mb-2">Tableau de bord</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ path('app_back') }}"><i class="fas fa-home me-1"></i>Accueil</a></li>
                <li class="breadcrumb-item active" aria-current="page">Tableau de bord</li>
            </ol>
        </nav>
    </div>
    <div>
        <button class="btn btn-sm btn-outline-primary" id="refreshDashboard" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt me-1"></i> Rafraîchir
        </button>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

<!-- Welcome Card -->
<div class="card mb-4 border-0 bg-gradient-primary" style="background: linear-gradient(135deg, #355EFC 0%, #2a4cd9 100%);">
    <div class="card-body p-4">
        <div class="d-flex align-items-center">
            <div class="me-4">
                <div class="bg-white bg-opacity-25 rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                    <i class="fas fa-user-tie text-white fa-2x"></i>
                </div>
            </div>
            <div>
                <h4 class="mb-2 text-white">Bienvenue dans le système de gestion des formations EasyHR</h4>
                <p class="text-white text-opacity-75 mb-0">Gérez facilement vos formations, quiz et questions depuis cette interface.</p>
            </div>
        </div>
        <div class="mt-4 d-flex gap-2 justify-content-end">
            <a href="{{ path('app_formation_new') }}" class="btn btn-sm btn-light">
                <i class="fas fa-plus me-1"></i> Nouvelle formation
            </a>
            <a href="{{ path('app_quiz_new') }}" class="btn btn-sm btn-light">
                <i class="fas fa-plus me-1"></i> Nouveau quiz
            </a>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
        <div class="card border-0 h-100 position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-primary opacity-10"></div>
            <div class="card-body p-4 position-relative">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-primary rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                            <i class="fas fa-graduation-cap text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase text-muted mb-1 small fw-semibold">Formations</h6>
                        <div class="d-flex align-items-baseline">
                            <h3 class="mb-0 fw-bold">{{ formations_count ?? 0 }}</h3>
                            <span class="badge bg-success ms-2">+12%</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="text-muted small">75%</span>
                </div>
                <a href="{{ path('app_formation_index') }}" class="stretched-link"></a>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
        <div class="card border-0 h-100 position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-info opacity-10"></div>
            <div class="card-body p-4 position-relative">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-info rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                            <i class="fas fa-question-circle text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase text-muted mb-1 small fw-semibold">Quiz</h6>
                        <div class="d-flex align-items-baseline">
                            <h3 class="mb-0 fw-bold">{{ quizzes_count ?? 0 }}</h3>
                            <span class="badge bg-success ms-2">+8%</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="text-muted small">65%</span>
                </div>
                <a href="{{ path('app_quiz_index') }}" class="stretched-link"></a>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
        <div class="card border-0 h-100 position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-success opacity-10"></div>
            <div class="card-body p-4 position-relative">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-success rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                            <i class="fas fa-list-ol text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase text-muted mb-1 small fw-semibold">Questions</h6>
                        <div class="d-flex align-items-baseline">
                            <h3 class="mb-0 fw-bold">{{ questions_count ?? 0 }}</h3>
                            <span class="badge bg-success ms-2">+15%</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="text-muted small">85%</span>
                </div>
                <a href="{{ path('app_question_index') }}" class="stretched-link"></a>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
        <div class="card border-0 h-100 position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-warning opacity-10"></div>
            <div class="card-body p-4 position-relative">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-warning rounded-circle p-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                            <i class="fas fa-check-circle text-white fa-lg"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase text-muted mb-1 small fw-semibold">Options</h6>
                        <div class="d-flex align-items-baseline">
                            <h3 class="mb-0 fw-bold">{{ options_count ?? 0 }}</h3>
                            <span class="badge bg-success ms-2">+5%</span>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 55%;" aria-valuenow="55" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="text-muted small">55%</span>
                </div>
                <a href="{{ path('app_option_index') }}" class="stretched-link"></a>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card border-0 h-100">
            <div class="card-header bg-transparent border-0 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Statistiques des formations</h5>
                        <p class="text-muted mb-0 small">Évolution des formations sur les 7 derniers mois</p>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" id="chartOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chartOptionsDropdown">
                            <li><a class="dropdown-item" href="#" onclick="exportChart('formationsChart', 'Statistiques_Formations'); return false;"><i class="fas fa-download me-2"></i>Exporter PNG</a></li>
                            <li><a class="dropdown-item" href="#" onclick="printChart('formationsChart'); return false;"><i class="fas fa-print me-2"></i>Imprimer</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="refreshChart('formationsChart'); return false;"><i class="fas fa-sync-alt me-2"></i>Actualiser</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="chart-container" style="height: 320px; position: relative;">
                    <canvas id="formationsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 h-100">
            <div class="card-header bg-transparent border-0 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Répartition des quiz</h5>
                        <p class="text-muted mb-0 small">Types de quiz dans le système</p>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" id="pieChartOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="pieChartOptionsDropdown">
                            <li><a class="dropdown-item" href="#" onclick="exportChart('quizzesChart', 'Repartition_Quiz'); return false;"><i class="fas fa-download me-2"></i>Exporter PNG</a></li>
                            <li><a class="dropdown-item" href="#" onclick="printChart('quizzesChart'); return false;"><i class="fas fa-print me-2"></i>Imprimer</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="chart-container" style="height: 320px; position: relative;">
                    <canvas id="quizzesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Data Section -->
<div class="row mb-4">
    <!-- Recent Formations -->
    <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="card border-0 h-100">
            <div class="card-header bg-transparent border-0 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Formations récentes</h5>
                        <p class="text-muted mb-0 small">Dernières formations ajoutées au système</p>
                    </div>
                    <a href="{{ path('app_formation_index') }}" class="btn btn-sm btn-primary">
                        Voir tout <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Titre</th>
                                <th>Date de création</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_formations is defined and recent_formations|length > 0 %}
                                {% for formation in recent_formations %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-graduation-cap text-white"></i>
                                                </div>
                                                <span class="fw-medium text-dark">{{ formation.titre }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ formation.dateCreation ? formation.dateCreation|date('d/m/Y') : '' }}</span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <a href="{{ path('app_formation_show', {'id': formation.id}) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Voir détails">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ path('app_formation_edit', {'id': formation.id}) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if is_granted('ROLE_ADMIN') or is_granted('DELETE', formation) %}
                                                <a href="#" class="btn btn-sm btn-outline-danger"
                                                   data-bs-toggle="tooltip"
                                                   title="Supprimer"
                                                   data-delete-url="{{ path('app_formation_delete', {'id': formation.id}) }}"
                                                   data-delete-token="{{ csrf_token('delete' ~ formation.id) }}"
                                                   data-entity-name="Formation">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center py-5">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="bg-light rounded-circle p-3 mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                                <i class="fas fa-folder-open text-muted" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <p class="mb-1 fw-medium">Aucune formation récente</p>
                                            <p class="text-muted small mb-0">Les formations que vous ajouterez apparaîtront ici</p>
                                            <a href="{{ path('app_formation_new') }}" class="btn btn-sm btn-primary mt-3">
                                                <i class="fas fa-plus me-1"></i> Ajouter une formation
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Quizzes -->
    <div class="col-lg-6">
        <div class="card border-0 h-100">
            <div class="card-header bg-transparent border-0 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Quiz récents</h5>
                        <p class="text-muted mb-0 small">Derniers quiz ajoutés au système</p>
                    </div>
                    <a href="{{ path('app_quiz_index') }}" class="btn btn-sm btn-primary">
                        Voir tout <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Titre</th>
                                <th>Formation</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_quizzes is defined and recent_quizzes|length > 0 %}
                                {% for quiz in recent_quizzes %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-info rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-question-circle text-white"></i>
                                                </div>
                                                <span class="fw-medium text-dark">{{ quiz.title }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if quiz.formation %}
                                                <span class="badge bg-primary-subtle text-primary">{{ quiz.formation.titre }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary-subtle text-secondary">Aucune</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <a href="{{ path('app_quiz_show', {'id': quiz.id}) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Voir détails">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ path('app_quiz_edit', {'id': quiz.id}) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if is_granted('ROLE_ADMIN') or is_granted('DELETE', quiz) %}
                                                <a href="#" class="btn btn-sm btn-outline-danger"
                                                   data-bs-toggle="tooltip"
                                                   title="Supprimer"
                                                   data-delete-url="{{ path('app_quiz_delete', {'id': quiz.id}) }}"
                                                   data-delete-token="{{ csrf_token('delete' ~ quiz.id) }}"
                                                   data-entity-name="Quiz">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center py-5">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="bg-light rounded-circle p-3 mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                                                <i class="fas fa-folder-open text-muted" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <p class="mb-1 fw-medium">Aucun quiz récent</p>
                                            <p class="text-muted small mb-0">Les quiz que vous ajouterez apparaîtront ici</p>
                                            <div class="d-flex gap-2 justify-content-center mt-3">
                                                <a href="{{ path('app_quiz_generate') }}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-magic me-1"></i> Générer
                                                </a>
                                                <a href="{{ path('app_quiz_new') }}" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-plus me-1"></i> Ajouter
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0">
            <div class="card-header bg-transparent border-0 pt-4 pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Actions rapides</h5>
                        <p class="text-muted mb-0 small">Accédez rapidement aux fonctionnalités principales</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ path('app_formation_new') }}" class="card border-0 h-100 text-decoration-none action-card">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-primary opacity-5 rounded-3"></div>
                            <div class="card-body p-4 text-center position-relative">
                                <div class="bg-primary rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                                    <i class="fas fa-graduation-cap text-white fa-lg"></i>
                                </div>
                                <h5 class="mb-2 fw-semibold">Nouvelle formation</h5>
                                <p class="text-muted mb-0 small">Créer une nouvelle formation dans le système</p>
                                <div class="mt-3 d-inline-block">
                                    <span class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus me-1"></i> Ajouter
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ path('app_quiz_new') }}" class="card border-0 h-100 text-decoration-none action-card">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-info opacity-5 rounded-3"></div>
                            <div class="card-body p-4 text-center position-relative">
                                <div class="bg-info rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                                    <i class="fas fa-question-circle text-white fa-lg"></i>
                                </div>
                                <h5 class="mb-2 fw-semibold">Nouveau quiz</h5>
                                <p class="text-muted mb-0 small">Ajouter un nouveau quiz d'évaluation</p>
                                <div class="mt-3 d-inline-block">
                                    <span class="btn btn-sm btn-info text-white">
                                        <i class="fas fa-plus me-1"></i> Ajouter
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ path('app_quiz_generate') }}" class="card border-0 h-100 text-decoration-none action-card">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-success opacity-5 rounded-3"></div>
                            <div class="card-body p-4 text-center position-relative">
                                <div class="bg-success rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                                    <i class="fas fa-magic text-white fa-lg"></i>
                                </div>
                                <h5 class="mb-2 fw-semibold">Générer un quiz</h5>
                                <p class="text-muted mb-0 small">Créer un quiz avec l'IA</p>
                                <div class="mt-3 d-inline-block">
                                    <span class="btn btn-sm btn-success text-white">
                                        <i class="fas fa-magic me-1"></i> Générer
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ path('app_question_new') }}" class="card border-0 h-100 text-decoration-none action-card">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-success opacity-5 rounded-3"></div>
                            <div class="card-body p-4 text-center position-relative">
                                <div class="bg-success rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                                    <i class="fas fa-list-ol text-white fa-lg"></i>
                                </div>
                                <h5 class="mb-2 fw-semibold">Nouvelle question</h5>
                                <p class="text-muted mb-0 small">Créer une nouvelle question pour un quiz</p>
                                <div class="mt-3 d-inline-block">
                                    <span class="btn btn-sm btn-success">
                                        <i class="fas fa-plus me-1"></i> Ajouter
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ path('app_option_index') }}" class="card border-0 h-100 text-decoration-none action-card">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-warning opacity-5 rounded-3"></div>
                            <div class="card-body p-4 text-center position-relative">
                                <div class="bg-warning rounded-circle p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                                    <i class="fas fa-check-circle text-white fa-lg"></i>
                                </div>
                                <h5 class="mb-2 fw-semibold">Gérer les options</h5>
                                <p class="text-muted mb-0 small">Administrer les options de réponse</p>
                                <div class="mt-3 d-inline-block">
                                    <span class="btn btn-sm btn-warning text-white">
                                        <i class="fas fa-cog me-1"></i> Gérer
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .action-card {
        overflow: hidden;
        position: relative;
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .action-card:hover {
        transform: translateY(-5px);
    }

    .action-card .btn {
        transition: all 0.3s ease;
    }

    .action-card:hover .btn {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize delete buttons
        initDeleteButtons();

        // Initialize form validation
        initFormValidation();

        // Chart.js Global Configuration
        Chart.defaults.font.family = "'Public Sans', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#64748b';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.8)';
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.titleFont = { weight: 'bold', size: 13 };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
        Chart.defaults.plugins.tooltip.bodySpacing = 6;
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.padding = 20;
        Chart.defaults.plugins.legend.labels.font = { size: 12, weight: 500 };

        // Line Chart - Formations Statistics
        const formationsCtx = document.getElementById('formationsChart').getContext('2d');
        const formationsChart = new Chart(formationsCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil'],
                datasets: [{
                    label: 'Formations créées',
                    data: [3, 5, 2, 8, 6, 7, 4],
                    backgroundColor: 'rgba(53, 94, 252, 0.1)',
                    borderColor: '#355EFC',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#355EFC',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#ffffff',
                    pointHoverBorderColor: '#355EFC',
                    pointHoverBorderWidth: 3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label + ' 2024';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                weight: '500'
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            borderDash: [3, 3],
                            drawBorder: false,
                            color: 'rgba(226, 232, 240, 0.8)'
                        },
                        ticks: {
                            stepSize: 2,
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    intersect: false,
                    axis: 'x'
                },
                elements: {
                    line: {
                        borderJoinStyle: 'round'
                    }
                }
            }
        });

        // Doughnut Chart - Quiz Distribution
        const quizzesCtx = document.getElementById('quizzesChart').getContext('2d');
        const quizzesChart = new Chart(quizzesCtx, {
            type: 'doughnut',
            data: {
                labels: ['Formations', 'Évaluations', 'Tests'],
                datasets: [{
                    data: [12, 8, 5],
                    backgroundColor: [
                        '#355EFC',
                        '#3b82f6',
                        '#10b981'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverOffset: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            boxWidth: 12,
                            font: {
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 800
                }
            }
        });

        // Initialize tooltips for action buttons
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                delay: { show: 100, hide: 100 }
            });
        });

        // Initialize toasts
        const toastElList = [].slice.call(document.querySelectorAll('.toast'));
        toastElList.map(function(toastEl) {
            return new bootstrap.Toast(toastEl);
        });
    });

    // Function to refresh dashboard
    function refreshDashboard() {
        // Show loading state
        const refreshBtn = document.getElementById('refreshDashboard');
        const originalContent = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Chargement...';
        refreshBtn.disabled = true;

        // Simulate refresh (in a real app, this would be an AJAX call)
        setTimeout(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
            showToast('Tableau de bord mis à jour avec succès', 'success');

            // Refresh chart data
            refreshChart('formationsChart');
            refreshChart('quizzesChart');
        }, 1000);
    }

    // Function to show toast notifications
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            const newContainer = document.createElement('div');
            newContainer.id = 'toastContainer';
            newContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(newContainer);
        }

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' :
                       type === 'error' ? 'bg-danger' :
                       type === 'warning' ? 'bg-warning' : 'bg-info';

        const textClass = type === 'warning' ? 'text-dark' : 'text-white';

        const toastHtml = `
            <div id="${toastId}" class="toast ${bgClass} ${textClass}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${bgClass} ${textClass} border-0">
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        document.getElementById('toastContainer').innerHTML += toastHtml;

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();

        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }



    // Function to export chart as PNG
    function exportChart(chartId, filename) {
        const canvas = document.getElementById(chartId);
        const image = canvas.toDataURL('image/png', 1.0);
        const link = document.createElement('a');
        link.download = filename + '.png';
        link.href = image;
        link.click();
    }

    // Function to print chart
    function printChart(chartId) {
        const canvas = document.getElementById(chartId);
        const dataUrl = canvas.toDataURL('image/png');
        const windowContent = `
            <!DOCTYPE html>
            <html>
                <head>
                    <title>Impression du graphique</title>
                    <style>
                        body { text-align: center; }
                        img { max-width: 100%; height: auto; }
                        h1 { font-family: Arial, sans-serif; color: #333; }
                    </style>
                </head>
                <body>
                    <h1>${chartId === 'formationsChart' ? 'Statistiques des formations' : 'Répartition des quiz'}</h1>
                    <img src="${dataUrl}" />
                    <p>Date d'impression: ${new Date().toLocaleDateString()}</p>
                </body>
            </html>
        `;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write(windowContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
            printWindow.close();
        };
    }

    // Function to refresh chart data
    function refreshChart(chartId) {
        const chart = Chart.getChart(chartId);
        if (!chart) return;

        // Simulate new data (in a real app, this would come from an API)
        if (chartId === 'formationsChart') {
            const newData = [Math.floor(Math.random() * 10), Math.floor(Math.random() * 10), Math.floor(Math.random() * 10),
                            Math.floor(Math.random() * 10), Math.floor(Math.random() * 10), Math.floor(Math.random() * 10),
                            Math.floor(Math.random() * 10)];
            chart.data.datasets[0].data = newData;
        } else if (chartId === 'quizzesChart') {
            const newData = [Math.floor(Math.random() * 15) + 5, Math.floor(Math.random() * 10) + 3, Math.floor(Math.random() * 8) + 2];
            chart.data.datasets[0].data = newData;
        }

        chart.update();
        showToast('Graphique mis à jour avec succès', 'success');
    }

    // Initialize delete buttons
    function initDeleteButtons() {
        document.querySelectorAll('[data-delete-url]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const url = this.getAttribute('data-delete-url');
                const token = this.getAttribute('data-delete-token');
                const entityName = this.getAttribute('data-entity-name') || 'Élément';

                if (typeof confirmDelete === 'function') {
                    confirmDelete(url, token, entityName);
                } else {
                    // Fallback if confirmDelete is not defined in Back_Base.html.twig
                    if (confirm(`Êtes-vous sûr de vouloir supprimer cet élément : ${entityName} ?`)) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = url;
                        form.style.display = 'none';

                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = '_token';
                        csrfInput.value = token;
                        form.appendChild(csrfInput);

                        document.body.appendChild(form);
                        form.submit();
                    }
                }
            });
        });
    }

    // Initialize form validation
    function initFormValidation() {
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                if (typeof validateForm === 'function') {
                    if (!validateForm(this)) {
                        e.preventDefault();
                        showToast('Veuillez corriger les erreurs dans le formulaire.', 'error');
                    }
                }
            });

            // Real-time validation on input change
            form.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('blur', function() {
                    if (typeof validateInput === 'function') {
                        validateInput(this);
                    }
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid') && typeof validateInput === 'function') {
                        validateInput(this);
                    }
                });
            });
        });
    }

    // Function to handle CRUD operations with feedback
    function handleCrudOperation(operation, entityType, successCallback, errorCallback) {
        try {
            // In a real app, this would be an AJAX call to your backend
            // Simulate success for demo purposes
            setTimeout(() => {
                if (Math.random() > 0.1) { // 90% success rate for demo
                    showToast(`${entityType} ${operation === 'create' ? 'créé' : operation === 'update' ? 'mis à jour' : operation === 'delete' ? 'supprimé' : 'traité'} avec succès`, 'success');
                    if (typeof successCallback === 'function') successCallback();
                } else {
                    // Simulate error
                    throw new Error(`Erreur lors de l'opération ${operation} sur ${entityType}`);
                }
            }, 800);
        } catch (error) {
            showToast(error.message, 'danger');
            if (typeof errorCallback === 'function') errorCallback(error);
        }
    }

    // Function to validate form inputs - using the global validateForm function
    function validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        // Use the global validateForm function from Back_Base.html.twig
        if (typeof window.validateForm === 'function') {
            return window.validateForm(form);
        }

        // Fallback implementation if the global function is not available
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');

                // Create or update feedback message
                let feedback = field.nextElementSibling;
                if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                    feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.style.display = 'block';
                    field.parentNode.insertBefore(feedback, field.nextElementSibling);
                }
                feedback.textContent = 'Ce champ est requis';
            } else {
                field.classList.remove('is-invalid');
                const feedback = field.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = '';
                    feedback.style.display = 'none';
                }
            }
        });

        // Focus on the first invalid field
        if (!isValid) {
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
            }
        }

        return isValid;
    }
</script>
{% endblock %}
