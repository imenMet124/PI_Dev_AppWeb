define(["ojs/ojcore","require","knockout","jquery","rappid","live-sql/api/worksheet/index","../slider-manager/SliderManager","live-sql/utils/apex-layout","./Parser","ojs/ojarraydataprovider","ojs/ojlistdataproviderview","live-sql/utils/debounce","../util/browser-checker/BrowserChecker","ojs/ojmodule","ojs/ojknockout","ojs/ojtoolbar","ojs/ojinputnumber","ojs/ojgauge","ojs/ojlabel","ojs/ojdialog","ojs/ojbutton","ojs/ojpopup","ojs/ojlistview","ojs/ojformlayout","./ExplainPlanDiagramViews","live-sql/components/loading/loader","live-sql/components/dbt-code-viewer/loader","../oj-dbt-panel-slider/loader","css!./css/dmw.css","css!./css/properties.css","css!./css/diagram.css","css!./css/rappid.css"],(function(e,require,t,o,r,a,n,i,l,s,p,c,d){return function(u){var g=this;g.loading=t.observable(!1),g.data=t.observable({}),g.composite=u.element,g.loadedCSSFiles=[],g.query=t.observable(),g.isFullyExpanded=!1,g.filterValue=t.observable(0),g.embedded=t.observable(!1),g.planNotesAvailable=t.observable(!1),g.refreshTextViewer=t.observable(!0),g.planNotes=t.observable(""),g.slider=n.instance,this._popUpId="explain-plan-diagram-statement-info-"+(new Date).getTime();const m={restoreText:e.Translations.getTranslatedString("core.util.apex_layout.expand"),collapseText:e.Translations.getTranslatedString("core.util.apex_layout.collapse"),title:e.Translations.getTranslatedString("core.util.apex_layout.resize")};g.layoutManager=new i(m),g.qp_diagram__layout__layoutSettings=g.layoutManager.createSetting({selector:"#qp_diagram_layout",minSize:280,maxSize:700,position:280,positionedFrom:"end",collapsed:!1}),u.props.then((function(e){g.query(e.query),e.embedded&&g.embedded(!0),g.data(e.data),g.updateDiagram()})),g.propertyChanged=function(e){"data"===e.property&&(g.data(e.value),g.updateDiagram())},g.ignoreNonNumbers=e=>{let t=e.which?e.which:e.keyCode,o=String.fromCharCode(t),r=o.replace(/[^0-9]/g,"");o!==r&&e.preventDefault()},g.filterValueChanged=async e=>{let t=e.detail.value;const o=await a.planTable(g.query(),t);g.data(o),g.updateDiagram()},g.filterCPUInputValue=function(){document.getElementById("cpu-cost-input-popup").open("#in-filter")},g.navigatorAdded=!1,g.addNavigator=function(){if(!g.navigatorAdded){var e=new r.ui.Navigator({paperScroller:g.paperScroller,width:280,height:150,padding:1,paperOptions:{perpendicularLinks:!0,background:{color:"#ebebeb"}},zoomOptions:{max:3,min:.2}});e.$el.appendTo("#dmw-navigator-holder"),e.render(),setTimeout((function(){g._resizeAction()}),0),g.navigatorAdded=!0}},g.updateDiagram=async function(){var e;if(g.loading(!0),await(e=100,new Promise((t=>setTimeout(t,e)))),g.navigatorAdded=!1,g.collapsableItems=[],g.isToggled=!1,g.clearSelection(),g.objectsMap.clear(),g.otherXmlList=[],g.mostCPUConsumedList=[],g.maxExecutionOrderNumber=0,g.filterCriterion={op:"$and",criteria:[{op:"$eq",value:{hidden:!1}}]},g.sortCriteria=[{attribute:"own_cpu_pct",direction:"descending"}],Object.keys(g.data()).length){var t=[];let e=0;b(t,g.data(),null,e),g.listDataProvider(new p(new s(g.mostCPUConsumedList,{keyAttributes:"id"}),{filterCriterion:g.filterCriterion,sortCriteria:g.sortCriteria})),g.graph.resetCells(t),g.graph.getElements()[0].position(10,10)}else g.loading(!1)};let h=Intl.NumberFormat("en",{notation:"compact"});function b(e,t,o,r){r++;let a=parseInt(t.total_cpu_pct,10),n=parseInt(t.own_cpu_pct,10),i="";t.access_predicates?i=t.access_predicates:t.hasOwnProperty("long_name")&&(i=t.long_name);let s="";if(t.options&&(s=" "+t.options),t.hasOwnProperty("other_xml")){let e=t.other_xml;l.parseXml(e,(e=>{g.otherXmlList.push(e)}))}let p=f(t,t.operation+s,a,n,i);if(e.push(p),t.execution_order&&(g.maxExecutionOrderNumber=Math.max(g.maxExecutionOrderNumber,t.execution_order),g.objectsMap.set(t.execution_order,p.attributes.id)),t.own_cpu_pct>=1&&g.mostCPUConsumedList.push({id:p.attributes.id,name:t.operation+s,own_cpu_pct:t.own_cpu_pct,execution_order:t.execution_order,description:i,hidden:!1}),o){let r=v(o,p,t.cardinality);e.push(r)}if(3===r&&g.collapsableItems.push(p),t.hasOwnProperty("children")){t.children.forEach((t=>{b(e,t,p,r)}))}}function f(e,t,o,a,n){var i=new r.shapes.qpd.QPObject;i.setOrder(e.execution_order||""),i.setType(t||""),i.setPercentage(o,a,e.total_cpu_cost||0,e.cpu_cost||0),i.setDescription(n||""),i.setCost(e.cost?.toString()||""),i.setIoCost(e.io_cost?.toString()||""),i.setInOut(e.other_tag?.toString()||""),i.setBytes(h.format(e.bytes||0));let l=Object.assign({},e,{});return i.setProperties(l),i.on("element:collapsed",(function(){g.treeLayout.layout()})),i}function v(e,t,o){let a=e.id+"_portId",n=new r.shapes.qpd.QPOLink({source:{id:e.id,port:a},target:{id:t.id}});return n.setLabel(o||0),e.getPort(a)||(e.addPort({group:"out",id:a}),e.togglePortSign(a)),n}function S(e,t){var o=!e.portProp(t,"collapsed");e.portProp(t,"collapsed",o),e.togglePortSign(t);var r=g.graph.getConnectedLinks(e,{outbound:!0});if(r)for(var a=0;a<r.length;a++){var n=r[a],i=n.findView(g.paper);if(t===n.attributes.source.port){var l=i.targetView.model;l.set({hidden:o}),n.set({hidden:o});var s=g.graph.getConnectedLinks(l,{outbound:!0});s&&s.forEach((function(e){if(o){var t=e.attributes.source.port;let o=l.getPort(t);o&&(l.portProp(o,"collapsed",!0),l.togglePortSign(t))}o&&e.set({hidden:o})})),o&&g.graph.getSuccessors(l).forEach((function(e){e.set({hidden:o});var t=g.graph.getConnectedLinks(e,{outbound:!0});t&&t.forEach((function(t){if(o){var r=t.attributes.source.port;let o=e.getPort(r);o&&(e.portProp(o,"collapsed",!0),e.togglePortSign(r))}t.set({hidden:o})}))}))}}g.updateListItemsStatus(),setTimeout((function(){g.paperScroller.adjustPaper()}),100)}g.objectProps=e=>{let t=e.attributes.type,r=e.getProperties();if("qpd.QPObject"===t){let t=[];o.each(r,(function(e,o){if("children"!==e&&"other_xml"!==e){let r=[];r.push(e),r.push(o),t.push(r)}}));let a=Object.assign({},r,{});a.hasOwnProperty("children")&&delete a.children,a.hasOwnProperty("other_xml")&&delete a.other_xml;let i={help_id:"dbt-explain-plan-diagram-object-properties"};if(i.items=[{id:"id-qpd-props-grid",type:"grid",title:"Properties",title_translation_id:"Properties",column_names:["Name","Value"],data:t,jsonData:a,showNullsVisible:!1}],g.otherXmlList.length){let e;1===g.otherXmlList.length?e=g.otherXmlList[0]:(e=[],g.otherXmlList.forEach((t=>{e.push(t)})));let t={id:"id-qpd-other-xml",type:"json",title:"Other XML",title_translation_id:"Other XML",data:e};i.items.push(t)}document.getElementById("explain-plan-panel-slider").style.zIndex=3,n.open({title:e.getType(),path:"live-sql/components/dbt-explain-plan/universal-form/UniversalForm",width:n.width.MEDIUM,args:{data:i}})}},g.expandAll=()=>{if(g.graph.getElements().length){let i=g.graph.getElements()[0];if(i.getPorts().length){let l=i.getPorts()[0].id;i.portProp(l,"collapsed",!1),i.togglePortSign(l);var e=g.graph.getConnectedLinks(i,{outbound:!0});if(e)for(var t=0;t<e.length;t++){var o=e[t],r=o.findView(g.paper);if(l===o.attributes.source.port){var a=r.targetView.model;a.set({hidden:!1}),o.set({hidden:!1});var n=g.graph.getConnectedLinks(a,{outbound:!0});n&&n.forEach((function(e){var t=e.attributes.source.port;let o=a.getPort(t);o&&(a.portProp(o,"collapsed",!1),a.togglePortSign(t)),e.set({hidden:!1})})),g.graph.getSuccessors(a).forEach((function(e){e.set({hidden:!1});var t=g.graph.getConnectedLinks(e,{outbound:!0});t&&t.forEach((function(t){var o=t.attributes.source.port;let r=e.getPort(o);r&&(e.portProp(r,"collapsed",!1),e.togglePortSign(o)),t.set({hidden:!1})}))}))}}}}},g.resetDiagram=()=>{g.collapsableItems.forEach((e=>{e.getPorts().length&&S(e,e.getPorts()[0].id)}))},g.showAdvancedView=function(){g.composite.dispatchEvent(new CustomEvent("showAdvancedView",{bubbles:!0,detail:{data:{}}}))},g.showChartView=function(){g.composite.dispatchEvent(new CustomEvent("showChartView",{bubbles:!0,detail:{data:{}}}))},g.printDiagram=function(){g.paper.print()},g.exportAsSVG=function(){const e=g.graph.getBBox().inflate(50);g.paper.toSVG((function(e){g.saveDiagram("ExplainPlanDiagram-",e)}),{area:e,convertImagesToDataUris:!0,preserveDimensions:g.paper.getComputedSize()})},g.saveDiagram=(e,t)=>{function o(e){return e>=100?o(e%100):(e<10?"0":"")+e}var r=new Date;var a={type:"text/plain;charset=UTF-8",name:e+o(r.getFullYear())+"-"+o(r.getMonth()+1)+"-"+o(r.getDate())+"_"+o(r.getHours()+1)+"-"+o(r.getMinutes())+".svg"},n=new Blob([t],{type:a.type});if(d.isMicrosoftBrowser())navigator.msSaveBlob(n,a.name);else{var i=window.URL.createObjectURL(n),l=document.createElement("a");document.body.appendChild(l),l.style="display: none",l.href=i,l.download=a.name,setTimeout((function(){l.click(),window.URL.revokeObjectURL(i),l.remove()}),0)}},g.zoomInFn=function(){g.paperScroller.zoom(.2,{max:3}),g.scrollToSelection()},g.zoomOutFn=function(){g.paperScroller.zoom(-.2,{min:.1}),g.scrollToSelection()},g.fitScreenFn=function(){g.paperScroller.zoomToFit({padding:0,scaleGrid:.2,minScale:.1,maxScale:3}),g.selectedObject?g.scrollToSelection():g.paperScroller.centerContent()},g.actualSizeFn=function(){g.paperScroller.zoom(1.5,{absolute:!0}),g.selectedObject?g.scrollToSelection():g.paperScroller.centerContent()},g.goToTop=()=>{g.paperScroller.positionContent("top",{padding:{vertical:20}})},g.expandAllFn=function(){g.isFullyExpanded=!0,g.expandAll(),g.treeLayout.layout(),setTimeout((function(){g.paperScroller.adjustPaper(),g.actualSizeFn(),g.selectedObject?g.scrollToSelection():g.goToTop(),g.updateListItemsStatus()}),100)},g.resetDiagramFn=function(){g.isFullyExpanded=!1,g.clearSelection(),g.expandAll(),g.resetDiagram(),g.treeLayout.layout(),setTimeout((function(){g.paperScroller.adjustPaper(),g.actualSizeFn(),g.goToTop(),g.updateListItemsStatus()}),100)},g.openInNewTabFn=function(){const e={statementText:g.query(),typeOutput:"explainPlanDiagram"};window.__output={},window.__output.params=e,window.open("?nav=output")},g.showPlanNotes=()=>{g.refreshTextViewer(!1),document.querySelector("#notesDialog").open(),g.refreshTextViewer(!0)},g.closeNotesDialog=()=>{document.querySelector("#notesDialog").close()},g.scrollToSelection=()=>{g.selectedObject&&g.paperScroller.scrollToElement(g.selectedObject)},g.nextObject=()=>{let e=0;g.selectedObject&&(e=g.selectedObject.getOrder());let t=g.maxExecutionOrderNumber,o=e+1,r=!1;for(;!r;){let e=g.objectsMap.get(o);if(e){let a=g.graph.getCell(e);a&&!a.get("hidden")?(r=!0,g.clearSelection(),g.makeSelected(a),g.paperScroller.isElementVisible(g.selectedObject,{strict:!0})||g.paperScroller.scrollToElement(g.selectedObject)):(o++,o>t&&(o=1))}else o++,o>t&&(o=1)}},g.previousObject=()=>{let e=g.maxExecutionOrderNumber,t=e+1;g.selectedObject&&(t=g.selectedObject.getOrder());let o=t-1,r=!1;for(;!r;){let t=g.objectsMap.get(o);if(t){let a=g.graph.getCell(t);a&&!a.get("hidden")?(r=!0,g.clearSelection(),g.makeSelected(a),g.paperScroller.isElementVisible(g.selectedObject,{strict:!0})||g.paperScroller.scrollToElement(g.selectedObject)):(o--,o<1&&(o=e))}else o--,o<1&&(o=e)}},g.selectedItems=t.observableArray([]),g.handleListSelectionChanged=e=>{let t=e.detail.value,o=Array.from(t.values());if(o.length){let e=o[0],t=g.graph.getCell(e);t&&(g.clearSelection(),g.makeSelected(t),g.paperScroller.isElementVisible(g.selectedObject,{strict:!0})||g.paperScroller.scrollToElement(g.selectedObject))}g.selectedItems([])},g.updateListItemsStatus=()=>{g.mostCPUConsumedList.forEach((e=>{let t=g.graph.getCell(e.id);if(t){let o=t.get("hidden")||!1;e.hidden=o}}));let e=document.getElementById("lv-most-cpu-consumed");e&&e.refresh()},g.showStatement=()=>{const e=document.getElementById(this._popUpId);e&&(e.isOpen()?e.close():e.open(e.id,{at:{horizontal:"start",vertical:"bottom"},my:{horizontal:"start",vertical:"top"},collision:"none"}))},g.execOrderTooltipRenderer=()=>{let e=document.createElement("div");return e.innerHTML="<html><p><b>Execution Order</b></p>Sequential number in the order of execution.</html>",{insert:e}},g.cpuCostTooltipRenderer=()=>({preventDefault:!0}),g.updatePlanNotes=()=>{if(g.otherXmlList.length){let e=[];g.otherXmlList.forEach((t=>{if(t.hasOwnProperty("info")&&Array.isArray(t.info)){t.info.forEach((t=>{t.hasOwnProperty("note")&&(e.push(t.type.replaceAll("_"," ").toUpperCase()),e.push("\n"),e.push(t.value),e.push("\n\n"))}))}})),e.length&&(g.planNotesAvailable(!0),g.planNotes(e.join("").trim()))}},g.attached=function(e){!function(){g.graph=new r.dia.Graph({},{cellNamespace:r.shape}),g.paper=new r.dia.Paper({width:100,height:100,gridSize:1,model:g.graph,cellViewNamespace:r.shapes,highlighting:!1,moveThreshold:5,clickThreshold:5,linkPinning:!1,sorting:r.dia.Paper.sorting.APPROX,interactive:{linkMove:!1,elementMove:!1},async:!0,viewport:function(e){return!e.model.get("hidden")}}),g.selectedObject=null,g.makeSelected=e=>{e.makeSelected(),g.selectedObject=e},g.clearSelection=()=>{g.selectedObject&&(g.selectedObject.clearSelection(),g.selectedObject=null)},g.paperScroller=new r.ui.PaperScroller({autoResizePaper:!1,padding:0,paper:g.paper}),o("#query-profile-diagram").append(g.paperScroller.render().el),g.collapsableItems=[],g.isToggled=!1,g.paper.on("render:done",(function(){g.isToggled||(g.isToggled=!0,g.isFullyExpanded||g.collapsableItems.forEach((e=>{e.getPorts().length&&S(e,e.getPorts()[0].id)})),g.treeLayout.layout(),g.updatePlanNotes(),setTimeout((function(){g.paperScroller.adjustPaper(),g.actualSizeFn(),g.goToTop(),g.loading(!1),g.addNavigator()}),250))})),g.treeLayout=new r.layout.TreeLayout({graph:g.graph,parentGap:80,siblingGap:60,direction:"B",filter:function(e){return e.filter((function(e){return!e.get("hidden")}))}}),g.paper.on("element:magnet:pointerclick",(function(e,t){t.stopPropagation();var o=e.findAttribute("port",t.target);o&&(S(e.model,o),g.treeLayout.layout())})),g.graph.on("change:hidden",(function(e,t,o){e.attr("./opacity",e.get("hidden")?0:1)})),g.paper.on("blank:pointerdown",((e,t,o)=>{g.clearSelection(),g.paperScroller.setCursor("grabbing"),g.paperScroller.startPanning(e,t,o)})),g.paper.on("blank:pointerup",(()=>{g.paperScroller.setCursor("default")})),g.paper.on("element:pointerup",(function(e){g.clearSelection(),g.makeSelected(e.model)})),g.paper.on("cell:pointerdblclick",(function(e){g.objectProps(e.model)})),new r.ui.Tooltip({rootTarget:document.body,target:"[data-tooltip]",padding:15}),g.toolbar=new r.ui.Toolbar({className:"joint-query-diagram-bottom-toolbar",tools:[{type:"button",name:"gototop",text:"",attrs:{button:{class:"oj-ux-ico-arrow-up","data-tooltip":"Scroll to Top"}}}]}),o("#query-profile-diagram").append(g.toolbar.render().$el),g.toolbar.on("gototop:pointerclick",(function(e){g.goToTop()})),this.keyboard&&this.keyboard.disable(),g.keyboard=new r.ui.Keyboard,g.keyboard.on({enter:function(e){g.selectedObject&&(e.preventDefault(),e.stopPropagation(),g.objectProps(g.selectedObject))},tab:function(e){e.preventDefault(),e.stopPropagation(),g.nextObject()},"shift+tab":function(e){e.preventDefault(),e.stopPropagation(),g.previousObject()}},this),g.objectsMap=new Map,g.otherXmlList=[],g.planNotesAvailable(!1),g.planNotes(""),g.maxExecutionOrderNumber=0,g.mostCPUConsumedList=[],g.listDataProvider=t.observable()}(),g.layoutManager.initialize(g.qp_diagram__layout__layoutSettings),g._initWindowResizeListener()},g.detached=function(e){window.removeEventListener("resize",g._resizeAction)},g._initWindowResizeListener=function(){g._resizeAction=c.debounce((()=>{const e=document.createEvent("Event");e.initEvent("resize",!1,!1);const t=document.querySelector("#qp_diagram_layout");t&&0!==t.offsetHeight&&t.dispatchEvent(e)}),250)}}}));